---
title: "Travaux pratiques 1"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Objectif

L'objectif de cette séance de travaux pratiques est de se familiariser avec l'analyse d'un jeu de données et de calculer des probabilités conditionnelles très simples. Le TP s'appuie sur une version du [défi "titanic"](https://www.kaggle.com/c/titanic), dont le but est de prédire le plus précisement possible la survie d'un passager lors du naufrage du Titanic en utilisant les informations connues (age, genre, classe sociale).

Le [naufrage du RMS Titanic](https://fr.wikipedia.org/wiki/Titanic) est l'un des naufrages les plus dramatiques de l'histoire de la navigation. Le 15 avril 1912, lors de son voyage inaugural, le Titanic coule après avoir heurté un iceberg, tuant 1502 des 2224 passagers et membres d'équipage. Cette tragédie a choqué la communauté internationale et conduit à l'amélioration des règles de sécurité pour les navires.

L'une des raisons du nombre de décès était qu'il n'y avait pas assez de canots de sauvetage pour les passagers et l'équipage. Certains groupes de personnes ont eu plus de chances de survivre que d'autres. Dans cette séance, nous analyserons les profils des personnes susceptibles de survivre au naufrage du Titanic. 

Des données d'apprentissage (**titanic_train**) contiennent les profils et l'information de survie de 1037 passagers. 


On prendra soin de commenter les codes R tout au long des questions du TP. Il est demandé de compléter certains codes en utilisant l'aide en ligne du programme avec la commande `help()`. 

**Tous les codes rendus devront être commentés et les commentaires compteront pour une par importante dans la note**.

# Exercice 1

* Lire les données de survie du naufrage du **Titanic**. Les données sont contenues dans le tableau de données `titanic_train`. Ce tableau contient des informations relatives à 1037 passagers, notamment la survie de ces passagers. 

```{r}
load("./data/titanic_train.rda")
tit_train <- titanic_train  
```

Les données se présentent de la manière suivante
```{r}
# help: head, View 
head(tit_train)
```

Chaque ligne représente un passager et neuf colonnes indiquent le profil du passager. Dans ce jeu de données, toutes les colonnes contiennent des variables binaires indiquant la réalisation des événements suivants :

- survived : le passager a survécu
- child : le passager était un enfant
- adult : le passager était un adulte
- elder : le passager était une personne agée
- family : le passager voyageait avec ses enfants ou ses parents
- gender : le passager était un homme
- class1 : le passager voyageait en classe 1.
- class2 : le passager voyageait en classe 2.
- class3 : le passager voyageait en classe 3.

* À partir de l'ensemble d'apprentissage, donner les probabilités de chacun des événements décrits dans la liste ci-dessus.  Arrondir les résultats à 2 décimales. 

**Solution.**

```{r}
# help: apply, mean, round

prob <- apply(tit_train, MARGIN = 2, FUN = mean)

round(prob, 2)

```


* Vérifier que l'on peut obtenir le résultat à l'aide du "pipe" de R. Cette instruction est similaire au **pipe** d'unix/linux. Elle transmet un objet à une fonction ou à une expression. L'object est alors pris comme premier argument de la fonction.

**Solution.**

```{r}
# help("|>")
# tit_train |> apply(MARGIN = change_me, FUN = change_moi) |> round(cambia_mi)
```



* Calculer la probabilité de survie sachant que l'on était un homme (`gender == 1`) ou une femme (`gender == 0`). Arrondir les résultats à 2 décimales. 

**Solution.**

```{r}
# help: list
# help: cat

cat("Probabilité de survie d'un homme :\n")
# mean(tit_train$survived[change_moi]) 

cat("Probabilité de survie d'une femme :\n")
# changeo_mio[tit_train$gender != 1] |> mean
```




* Vérifier votre résultat avec une représentation des données par un diagramme en barre 

**Solution.** Il n'y a rien à faire sauf exécuter le code. 

```{r}
# help: factor
# help: plot

# c'est quand même plus court (size matters)
sex <- tit_train$gender

# ah oui, femme et homme en anglais, c'est comme ca.
sex[tit_train$gender == 0] <- "female"
sex[tit_train$gender == 1] <- "male"

# factor est un type très utilisé lorsque les variables sont des catégories
# la méthode d'affichage est adaptée aux objects de type "factor"
plot(factor(sex), 
     factor(tit_train$survived), 
     col = c("orange","black"),
     xlab = "Gender",
     ylab = "Survival")
```


* Calculer la proportion d'hommes parmi les survivants.  Quelle est la probabilité conditionnelle correspondant ?

**Solution.**

```{r}
#comment: probabilité conditionnelle correspondant
 mean( le_bon_truc )
```



* Calculer la probabilité de survie d'un individu sachant sa classe à bord (colonnes 7 à 9 dans le tableau de données). Arrondir les résultats à 2 décimales. 

**Solution.**

```{r}
colonnes <- 7:9

# Ecrire une fonction qui retourne la probabilité demandée pour la colonne j
mean_class <- function(j) {
    # ca_tient_en_une_ligne
  }

# appliquer la fonction aux colonnes 7:9
# help: sapply

prob <- sapply(colonnes, mean_class)
names(prob) <- names(tit_train[,7:9])
# round(prob, akmalani)
```




# Exercice 2

Dans cet exercice, on construit des prédicteurs s'appuyant sur les probabilités empiriques de survie pour les profils de sexe, de classe et d'age. L'idée est très simple. Par exemple, pour prédire la survie d'une femme adulte ou agée, on calculera la probabilité conditionnelle de survie à partir de l'ensemble d'apprentissage (`tit_train`). On prédit  que le passager survit  si cette probabilité est supérieure à 0.5 ou un autre seuil de probabilité plus ou moins élevé.  

* Calculer les probabilités de survie d'un passager sachant les variables `gender` et `child` (4 cas). Arrondir à deux décimales.

**Solution.**

```{r}
## attach permet d'utiliser directement les noms des variables d'un data.frame
## par exemple, on peut utiliser 'gender' à la place de 'tit_train$gender'

attach(tit_train)
cat("femmme adulte ou agée :\n") 
# mean(survived[ trouve_la_bonne_condition ])
cat("homme adulte ou agé :\n")
# mean(survived[ copier_c_est_pas_beau ])
cat("jeune fille :\n")
# mean(survived[ et_coller_c_est_trop_dur ])
cat("jeune garçon :\n")
mean(survived[gender == 1 & child == 1])
detach(tit_train)
```

* Calculer les probabilités de survie d'une femme en première et en troisième classe. Idem pour un homme. Indiquer les probabilités conditionnelles calculées en commentaire ? Arrondir à deux décimales.

**Solution.**

```{r}
attach(tit_train)
#comment 1: probabilité conditionnelle 
cat("Probabilité de survie d'une femme en classe 1 : ")
#mean(survived[ change_moi & class1])

#comment 2: probabilité conditionnelle 
cat("Probabilité de survie d'une femme en classe 3 : ")
#mean(survived[ cambia_mi ])

#comment 3: probabilité conditionnelle 
cat("Probabilité de survie d'une homme en classe 1 : ")
#mean( tu_as_tout_compris )

#comment 4: probabilité conditionnelle 
cat("Probabilité de survie d'une homme en classe 3 : ")
#mean( mais_l_heure_tourne )
detach(tit_train)
```



* Calculer le nombre moyen de prédictions correctes effectuées sur l'ensemble d'apprentissage en considérant les probabilités de survie conditionnelle aux variables `gender` et `class3`. Pour cela, on prédit qu'un  passager survit lorsque la probabilité conditionnelle de survie est supérieure à 0.5 et qu'il ne survit pas lorsque la probabilité conditionnelle de survie est inférieure à 0.5.

**Solution.**


```{r}

# Commenter la fonction ligne par ligne  
survprob <- function(i)
  {
    #
    passenger <- tit_train[i,] 
    #
    bool <- tit_train$gender == passenger$gender & tit_train$class3 == passenger$class3 
    #
    mean(tit_train$survived[bool])
  }

pred <- sapply(1:n, survprob)

#  accuracy <- sum( tit_train$survived == logical_qui_que_quoi )/nrow(tit_train)

  if ( round(accuracy, 4) != 0.7888){
  stop("Erreur : Essaie encore !")
  } else { 
    cat("Accuracy: ", accuracy) 
    }

```


* Représenter les résultats sous forme de [matrice de confusion](https://fr.wikipedia.org/wiki/Matrice_de_confusion) à l'aide de la fonction `table`.


**Solution.**

```{r}
# help: table
# table(tit_train$survived, logical_qui_que_quoi , dnn = c("survie", "prediction empirique"))
```


* En utilisant un code précédent, prédire la survie de chaque passager à partir des fréquences de survie conditionnelle aux variables `gender`, `child` et `class3`. Calculer le nombre de prédictions correctes effectuées. Représenter les résultats sous forme de matrice de confusion à l'aide de la fonction `table`. Comparer aux résultats précédents.

**Solution.**


* Reprendre la question précédente avec les variables `gender`, `child`, `class3` et `family`.
Calculer le nombre de prédictions correctes effectuées. Représenter les résultats sous forme de matrice de confusion à l'aide de la fonction `table`. Comparer aux résultats précédents.

**Solution.**

* D'après vous, quelles variables ont été les plus influentes pour la survie d'un passager lors de la catastrophe du Titanic ?


**Solution.**



# Exercice 3. Un peu d'intelligence artificielle.

Nous souhaitons comparer les prédictions effectuées à l'aide des probabilités conditionnelles ( sachant `gender`, `child`, `family`, `class3`) à celles obtenues par des modèles de prédiction probabiliste plus sophistiqués. Pour cela, nous construisons des  modèles de réseau de neurones feed-forward, ayant 3 (ou 5) neurones cachés. 

Dans ce TP, il n'est pas utile de savoir comment fonctionne un réseau de neurones. On considère qu'il s'agit d'une "machine" ou "boîte noire" dont les données d'entrée sont les caractéristiques des passagers et la donnée de sortie est la survie des passagers. La machine cherche à reconstruire la sortie à partir des données d'entrée par une méthode d'optimisation numérique.    

Afin d'améliorer l'optimisation du modèle de réseau de neurones, il peut être intéressant de répéter l'opération plusieurs fois en changeant la valeur `seed()` du générateur aléatoire, car cela influence les conditions initiales de la méthode d'optimisation. Pour le rendu, on prendra soin de fixer le paramètre `seed` à une valeur particulière.

**Solution.** On peut se contenter d'exécuter le code ci-dessous.

```{r}
# input : on enleve la variable de survie (premiere colonne)
  x <- tit_train[,-1]

# output : la variable survie
  y <- tit_train[,1]
  
# On ajuste un réseau de neurones et on calcule les prédictions de ce réseau 
# ce sont des probabilités conditionnelles 
# help : nnet::nnet
  set.seed(12)
  mod_nnet <- nnet::nnet(x, y, size = 3)
  pred_nnet <- predict(mod_nnet)
```


* À l'aide du vecteur `pred_nnet`, calculer les nombres de prédictions correctes et incorrectes effectuées par le modèle neuronal que vous venez d'ajuster, ainsi que la proportion de bons classements (accuracy). Afficher une matrice de confusion.

**Solution.**


```{r}
# commenter
  table(tit_train$survived, allez_ca_y_est_je_demande_a_chatgpt)

# commenter
  accuracy <- sum(tit_train$survived == mais_non_tiens_bon)/nrow(tit_train)
  cat("Accuracy: ", accuracy,"\n")
```

* À l'aide d'une table, quantifier les différences entre les prédictions de survie s'appuyant sur les probabilités empiriques calculées à partir de trois prédicteurs `gender`, `child`, `family`,  et `class3` et celles estimées  par le modèle neuronal. Commenter votre résultat.

**Solution.**


* A l'aide d'un graphique, comparer les probabilités conditionnelles empiriques à celles calculées par le réseau de neurones ? Utiliser si possible des couleurs différentes pour huit catégories de passagers considérés : femmes/hommes, enfants/adultes, classe 1-2/classe 3. 

**Solution.**

```{r}
tit_train$color <- 1+tit_train$gender + 2*tit_train$child + 4*tit_train$class3

# comment 1

my.colors = c("grey" , #femme adult cl12
              "blue" , #homme adult cl12
              "pink" , #femme enfant cl12
              "lightblue" , #homme enfant cl12  
              "orange" , #femme adult cl3
              "darkblue" , #homme adult cl3
              "violet" , #femme enfant cl3
              "palegreen"  #homme enfant cl3 
              )

```

* En utilisant les probabilités empiriques et celles calculées par le réseau de neurones, calculer le nombre (espérance) de femmes, d'hommes, d'enfants survivant à la catastrophe. Justifier mathématiquement la formule utilisée. 

**Solution.**

```{r}
# Exemple : prédiction du nombre de survivantes (femmes) par un reseau de neurones

# sum(pred_nnet[tit_train$gender == 0])
```



* Reprendre la question pour toutes les variables du tableau de données (femmes, hommes, enfants, adultes, personnes agées, famille, classes 1 à 3). Créer un graphique qui résume les résultats pour les 9 variables et les compare aux nombres observés dans les données.

**Solution.**

```{r}
 cat_names <- c("child", "adult", "elder", "family", "male", "female", "class1", "class2", "class3")

tit_train$male <- tit_train$gender
tit_train$female <- 1-tit_train$gender

## completer
## on pourra utiliser tapply() : par exemple, tapply(pred, tit_train[,"child"], sum)["1"] pour la categorie enfant
# N_empirique <- Esperance_nombre_de survivant_par_categorie_empirique
# N_neuronal <-  Esperance_nombre_de survivant_par_categorie_modele_neuronal
# N_reel <- nombre_de survivant_par_categorie
```



```{r}

# Comparaison des predictions empiriques et neuronales
barplot(
  rbind(N_reel, N_empirique, N_neuronal), 
  ylim = c(0, 340),
  beside = TRUE, 
  col = c("orange", "blue", "lightblue"), 
  names.arg = cat_names,
  legend.text = c("Nombre de survivants", "Prédiction empirique", "Prédiction neuronale"),
  args.legend = list(x = "topright",
                           inset = c(0, -0.05)),
  xlab = "Caractéristique du passager",
  ylab = "Nombre de survivants",
  cex.names=0.8
)
```

* Prédire la survie de chaque passager à partir des fréquences de survie conditionnelle aux variables `gender`, `child`, `adult`, `family`, `class2` `class3`. Expliquer pourquoi on dispose ainsi de toute l'information sur chaque passager. À l'aide d'une matrice de confusion, 
comparer les résultats à ceux du réseau de neurones précédent.  

 **Solution.**
 
* Finalement, que fait un réseau de neurones ? 
 
 **Solution.**
 
